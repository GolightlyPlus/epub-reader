<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mobile EPUB Reader</title>
        <script src="/libraries/jszip.min.js"></script>
        <script src="/libraries/epub.min.js"></script>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #viewer {
                width: 100%;
                height: 100vh;
                overflow: hidden;
            }

            .tap-area {
                position: fixed;
                top: 0;
                height: 100%;
                width: 50%;
                z-index: 10;
            }

            #left-tap {
                left: 0;
            }

            #right-tap {
                right: 0;
            }
        </style>
    </head>
    <body>
        <div id="viewer"></div>

        <div class="tap-area" id="left-tap"></div>
        <div class="tap-area" id="right-tap"></div>

        <script>
            async function initReader() {
                try {
                    console.log('Starting book load');
                    const response = await fetch('/book.epub');
                    const arrayBuffer = await response.arrayBuffer();
                    console.log('File loaded, size:', arrayBuffer.byteLength);

                    book = ePub();
                    await book.open(arrayBuffer);
                    console.log(
                        'Book opened, spine items:',
                        book.spine.items.length
                    );

                    rendition = book.renderTo('viewer', {
                        width: '100%',
                        height: '100%',
                        flow: 'paginated',
                        spread: 'none'
                    });

                    // Display first page
                    await rendition.display();

                    // Only set up event listeners after book is loaded and displayed
                    setupEventListeners();
                } catch (error) {
                    console.error('Detailed error:', error);
                    alert('Error loading book');
                }
            }

            function setupEventListeners() {
                // Setup touch events for mobile
                let touchStart = null;
                let touchEnd = null;

                document.addEventListener('touchstart', e => {
                    touchStart = e.changedTouches[0].screenX;
                });

                document.addEventListener('touchend', e => {
                    touchEnd = e.changedTouches[0].screenX;
                    handleSwipe();
                });

                function handleSwipe() {
                    if (touchStart && touchEnd) {
                        const diff = touchStart - touchEnd;
                        if (Math.abs(diff) > 50) {
                            if (diff > 0) {
                                rendition.next();
                            } else {
                                rendition.prev();
                            }
                        }
                    }
                }

                // Add tap event listeners
                document
                    .getElementById('left-tap')
                    .addEventListener('click', () => {
                        rendition && rendition.prev();
                    });

                document
                    .getElementById('right-tap')
                    .addEventListener('click', () => {
                        rendition && rendition.next();
                    });

                // Keyboard navigation
                document.addEventListener('keyup', e => {
                    if (!rendition) return;
                    if (e.key === 'ArrowLeft') {
                        rendition.prev();
                    }
                    if (e.key === 'ArrowRight') {
                        rendition.next();
                    }
                });
            }

            // Initialize when page loads
            initReader();
        </script>
    </body>
</html>
